<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
	<title></title>
	<style type="text/css">
		body{
			padding: 0px;
			margin: 0px;
		}
		canvas{
			border: 1px solid black;
			    cursor: none;
			    width: 360px;
			    height:600px;
		}
		div{
			text-align: center;
		}
	</style>
</head>
<body>
	<div id='content'>
	</div>
	<script type="text/javascript" src="./jquery.js"></script>
	<script type="text/javascript">
		var canvas = $("<canvas id='canvas' width='600' height='1000'></canvas>");
		var finished = false;
		var width = canvas.get(0).width;
		var height = canvas.get(0).height;
		var direction = null;
		var score = 0;
		var keydown = [];
		var speed = 8;
		var foeArr = [];
		canvas.appendTo('#content');
		var ctx = canvas.get(0).getContext("2d");

		var player = {
			x:275,
			y:950,
			width:50,
			height:50,
			lift:10,
			bullet:[]
		}
		for(var i=0; i<128; i++){
		  keydown[i] = false;
		}

		$(document).keydown(function(e){
			keydown[e.which] = true;
		})
		$(document).keyup(function(e){
		  	keydown[e.which] = false;
		});

		var timer = setInterval(function(){
		  update();
		  draw();
		}, 16);

		var timer0 = setInterval(function(){
			foeArr.push(new foe());
		},5000)
		
		var timer1 = setInterval(function(){
			if(keydown[32]){
				addBullet.call(player);
			}
		},100)

		var timer2 = setInterval(function(){
			foeArr.forEach(function(foe){
				if(foe.active){
					addBullet.call(foe,true);
				}
			})
			
		},300)

		function draw(){
		  if (finished==false){
		  ctx.clearRect(0,0,width,height);

		  player.bullet.forEach(function(bullet){
		  	if(bullet.active){
		  		bullet.draw();
		  		ctx.globalCompositeOperation = 'source-over' ;
		  	}
		  })

		  foeArr.forEach(function(foe){
		  		foe.draw();
		  		foe.bullet.forEach(function(bullet){
			  		if(bullet.active){
				  		bullet.draw();
				  		ctx.globalCompositeOperation = 'source-over' ;
				  	}
			  	})
		  })

		  ctx.fillStyle = "black";
		  ctx.fillRect(player.x,player.y,50,50);
		  
		  ctx.fillStyle = "black";
		  ctx.font = 'italic normal 200 20px arial';
		  ctx.fillText(" Score: " + score, 10, 20);
		  ctx.fillText(" lift: " + player.lift, 10, 40);


		  }else{
		  	clearInterval(timer0);
		  	clearInterval(timer1);
		  	clearInterval(timer2);
		    ctx.clearRect(0,0,width,height);
		    ctx.fillText(" 击杀 " + score + "敌机", 80, 120);
		  }  

		}

		function update(){
			if(finished){
				return;
			}
			player.bullet.forEach(function(bullet){
				if(bullet.y<0){
					bullet.active = false;
				}
				bullet.y -= 5;
			})
			if(keydown[38]){
				player.y -= speed; 
			}
			if(keydown[40]){
				player.y += speed;
			}
			if(keydown[37]){
				player.x -= speed;
			}
			if(keydown[39]){
				player.x += speed;
			}
			player.x = player.x<0?0:player.x;
			player.x = player.x>550?550:player.x;
			player.y = player.y<0?0:player.y;
			player.y = player.y>950?950:player.y;
			foeArr.forEach(function(foe,index){
				foe.move();
				// if(foe.bullet.y>height){
				// 	foe.bullet.active = false;
				// }
				over(foe);
				foe.bullet.forEach(function(bullet){
					bullet.y+=10;
				})
			})
		}

		function addBullet(foe){
			var obj = this;
			var bullet = {
				foe:foe,
				active:true,
				x:obj.x+obj.width/2,
				y:obj.y-5,
				draw:function(){

					ctx.beginPath();
					
					ctx.fillStyle = '#000';
					if(foe){
						ctx.arc(this.x, this.y+10, 5,0,Math.PI*2,true);
					}else{
						ctx.arc(this.x, this.y, 5,0,Math.PI*2,true);
					}
					ctx.fill();
					ctx.closePath();
				}
			}

			this.bullet.push(bullet);
		}
		
		function over (foe){
			if(foe.active){
				if((player.x-foe.width <foe.x )&& (foe.x < player.x+50)&& (player.y-foe.height<foe.y)&& (player.y+50>foe.y)){
					finished = true;
				}//撞到player
				//foe减血
				player.bullet.forEach(function(bullet){
					if(bullet.active&&bullet.x>foe.x&&bullet.x<foe.x+foe.width&&bullet.y>foe.y&&bullet.y<foe.y+foe.height){
						bullet.active=false;
						foe.lift--;
					}
					if(foe.active&&foe.lift<=0){
						foe.active = false;
						score++;
					}
				})
			}
			
			//player减血
			foe.bullet.forEach(function(bullet){
				if(bullet.active&&bullet.x>player.x&&bullet.x<player.width+player.x&&bullet.y>player.y&&bullet.y<player.y+player.height){
					bullet.active = false;
					player.lift--;
				}
				if(player.lift <= 0){
					finished = true;
				}
			})
		}

		function foe(){
			this.lift = 5;
			this.speed = 5;
			this.x = Math.random()*width;
			this.y = 0;
			this.width = 60;
			this.height = 20;
			this.bullet = [];
			this.active = true;
		}
		foe.prototype.move = function(){
			if(this.x!=player.x){
				this.x = (this.x>player.x)?this.x-2:this.x+2;
			}
			this.y+=this.speed;
			if(this.x<0||this.y>height||this.x>width){
				this.bullet.forEach(function(bullet){
					if(bullet.x<0||bullet.y>height||bullet.x>width){
						bullet.active = false;
					}
				})
				this.active = false;
			}
		}	
		foe.prototype.draw = function(){
			if(this.active){
				ctx.beginPath();
				ctx.fillStyle = "blue";
			  	ctx.fillRect(this.x,this.y,this.width,this.height);
			  	ctx.closePath();
			}	
		}
	</script>
</body>
</html>